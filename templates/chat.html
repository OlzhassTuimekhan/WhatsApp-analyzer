<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>AI –ß–∞—Ç - –ê–Ω–∞–ª–∏–∑ —á–∞—Ç–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
        }
        
        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar {
            width: 260px;
            background: #1e3a5f;
            color: white;
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 0 20px 30px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .sidebar-logo {
            font-size: 24px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
        }
        
        .sidebar-menu li {
            margin: 5px 0;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .sidebar-menu a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .sidebar-menu a.active {
            background: rgba(255,255,255,0.15);
            color: white;
            border-left-color: #4a90e2;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            margin-left: 260px;
            flex: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* –•–µ–¥–µ—Ä */
        .top-header {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #4a90e2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç —á–∞—Ç–∞ */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
        }
        
        .chat-header h2 {
            color: #1e3a5f;
            margin-bottom: 10px;
        }
        
        .api-key-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .api-key-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .api-key-input:focus {
            outline: none;
            border-color: #4a90e2;
        }
        
        .save-key-btn {
            padding: 8px 16px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .save-key-btn:hover {
            background: #357abd;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .message.user {
            align-items: flex-end;
        }
        
        .message.ai {
            align-items: flex-start;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }
        
        .message.user .message-bubble {
            background: #4a90e2;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.ai .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            padding: 0 4px;
        }
        
        .chat-input-area {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            resize: none;
            max-height: 120px;
        }
        
        .chat-input:focus {
            border-color: #4a90e2;
        }
        
        .send-btn {
            padding: 12px 24px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .send-btn:hover:not(:disabled) {
            background: #357abd;
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading-indicator {
            display: inline-block;
            padding: 8px 12px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            color: #666;
            font-size: 14px;
        }
        
        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .suggestion-chip {
            padding: 6px 12px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .suggestion-chip:hover {
            background: #4a90e2;
            color: white;
            border-color: #4a90e2;
        }
        
        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #fcc;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block !important;
            }
            
            .mobile-overlay.active {
                display: block !important;
            }
            
            .sidebar {
                width: 280px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.mobile-visible {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .top-header {
                padding: 15px;
                flex-wrap: wrap;
            }
            
            .chat-container {
                margin: 10px;
                border-radius: 8px;
            }
            
            .chat-header {
                padding: 15px;
            }
            
            .chat-header h2 {
                font-size: 18px;
            }
            
            .api-key-input {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .api-key-section {
                flex-direction: column;
            }
            
            .save-key-btn {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }
            
            .chat-input {
                font-size: 16px;
                padding: 15px;
            }
            
            .send-btn {
                padding: 15px 20px;
                font-size: 16px;
                min-height: 50px;
            }
            
            .message-bubble {
                max-width: 85%;
                padding: 15px;
                font-size: 15px;
            }
            
            .suggestion-chip {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
        
        /* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è —Ç–∞–ø–æ–≤ */
        button, .suggestion-chip, .save-key-btn, .send-btn {
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        input, textarea {
            font-size: 16px !important;
            touch-action: manipulation;
        }
    </style>
</head>
<body>
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" style="position: fixed; top: 15px; left: 15px; z-index: 1001; background: #1e3a5f; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: none;">‚ò∞</button>
    <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>
    <!-- –°–∞–π–¥–±–∞—Ä -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <span>ChatAnalyzer</span>
            </div>
        </div>
        <ul class="sidebar-menu">
            <li><a href="/"><span></span> –ê–Ω–∞–ª–∏–∑</a></li>
            <li><a href="/chat" class="active"><span></span> AI –ß–∞—Ç</a></li>
        </ul>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-content">
        <!-- –•–µ–¥–µ—Ä -->
        <div class="top-header">
            <div class="header-left">
                <h1 style="color: #1e3a5f; font-size: 20px;">AI –ê–Ω–∞–ª–∏–∑ —á–∞—Ç–∞</h1>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar">–û</div>
                    <span>Olzhas</span>
                </div>
            </div>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ -->
        <div class="chat-container">
            <div class="chat-header">
                <h2>üí¨ –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ –≤–∞—à–µ–º —á–∞—Ç–µ</h2>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    AI –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à—É –ø–µ—Ä–µ–ø–∏—Å–∫—É –∏ –æ—Ç–≤–µ—Ç–∏—Ç –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã
                </p>
                <div class="api-key-section">
                    <input 
                        type="password" 
                        id="apiKeyInput" 
                        class="api-key-input" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à OpenAI API key (sk-...)"
                    >
                    <button class="save-key-btn" onclick="saveApiKey()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á</button>
                    <button class="save-key-btn" onclick="clearApiKey()" style="background: #dc3545;">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message ai">
                    <div class="message-bubble">
                        –ü—Ä–∏–≤–µ—Ç! üëã –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–µ–≥–æ —á–∞—Ç–∞. –ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –æ –≤–∞—à–µ–π –ø–µ—Ä–µ–ø–∏—Å–∫–µ!
                    </div>
                    <div class="message-time">–°–∏—Å—Ç–µ–º–∞</div>
                </div>
                
                <div class="suggestions">
                    <div class="suggestion-chip" onclick="askQuestion('–ö–∞–∫–∏–µ —Å–∞–º—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –Ω–∞—à–µ–º –æ–±—â–µ–Ω–∏–∏?')">
                        –ö–∞–∫–∏–µ —Å–∞–º—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã?
                    </div>
                    <div class="suggestion-chip" onclick="askQuestion('–ö—Ç–æ –ø–∏—à–µ—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π?')">
                        –ö—Ç–æ —Å–∞–º—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π?
                    </div>
                    <div class="suggestion-chip" onclick="askQuestion('–í –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –º—ã —á–∞—â–µ –≤—Å–µ–≥–æ –æ–±—â–∞–µ–º—Å—è?')">
                        –ö–æ–≥–¥–∞ –º—ã —á–∞—â–µ –≤—Å–µ–≥–æ –æ–±—â–∞–µ–º—Å—è?
                    </div>
                    <div class="suggestion-chip" onclick="askQuestion('–ö–∞–∫–∏–µ —Ç–µ–º—ã –º—ã –æ–±—Å—É–∂–¥–∞–µ–º —á–∞—â–µ –≤—Å–µ–≥–æ?')">
                        –û —á–µ–º –º—ã —á–∞—â–µ –≤—Å–µ–≥–æ –≥–æ–≤–æ—Ä–∏–º?
                    </div>
                    <div class="suggestion-chip" onclick="enableDateAndAsk('–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å?')">
                        üìÖ –ß—Ç–æ –±—ã–ª–æ –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å?
                    </div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <div id="errorMessage" style="display: none;" class="error-message"></div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                        <input 
                            type="checkbox" 
                            id="enableDateAnalysis" 
                            onchange="toggleDateSelector()"
                            style="width: 18px; height: 18px; cursor: pointer;"
                        >
                        <span style="color: #333; font-size: 14px; font-weight: 500;">üìÖ –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–Ω—è</span>
                    </label>
                    <input 
                        type="date" 
                        id="dateSelector" 
                        disabled
                        style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; flex: 1; max-width: 200px; background: #f0f0f0; cursor: not-allowed;"
                        onchange="updateDateLabel()"
                    >
                    <button 
                        class="save-key-btn" 
                        onclick="clearDate()" 
                        style="background: #6c757d; padding: 8px 16px; font-size: 14px; display: none;"
                        id="clearDateBtn"
                    >
                        –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                </div>
                <div class="chat-input-container">
                    <textarea 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ –≤–∞—à–µ–º —á–∞—Ç–µ..."
                        rows="1"
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let conversationHistory = [];
        let apiKey = localStorage.getItem('openai_api_key') || '';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫–ª—é—á
        if (apiKey) {
            document.getElementById('apiKeyInput').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + apiKey.slice(-4);
        }
        
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            let key = input.value.trim();
            
            if (!key) {
                alert('–í–≤–µ–¥–∏—Ç–µ API key');
                return;
            }
            
            // –ï—Å–ª–∏ –∫–ª—é—á —É–∂–µ –±—ã–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ
            if (key.startsWith('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
                input.value = '';
                input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π API key';
                return;
            }
            
            apiKey = key;
            localStorage.setItem('openai_api_key', key);
            input.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + key.slice(-4);
            input.type = 'password';
            
            showMessage('‚úÖ API key —Å–æ—Ö—Ä–∞–Ω–µ–Ω! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã.', 'ai');
        }
        
        function askQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendMessage();
        }
        
        function enableDateAndAsk(question) {
            const checkbox = document.getElementById('enableDateAnalysis');
            const dateInput = document.getElementById('dateSelector');
            
            // –í–∫–ª—é—á–∞–µ–º —á–µ–∫–±–æ–∫—Å –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –¥–∞—Ç—ã
            checkbox.checked = true;
            toggleDateSelector();
            
            // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            if (!dateInput.value) {
                showError('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–Ω—è');
                dateInput.focus();
                return;
            }
            
            document.getElementById('chatInput').value = question;
            sendMessage();
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!apiKey) {
                showError('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤–∞—à OpenAI API key');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω –ª–∏ –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–Ω—è
            const enableDateCheckbox = document.getElementById('enableDateAnalysis');
            const dateInput = document.getElementById('dateSelector');
            let selectedDate = null;
            
            if (enableDateCheckbox.checked) {
                selectedDate = dateInput.value;
                if (!selectedDate) {
                    showError('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–Ω—è');
                    return;
                }
            }
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            input.value = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –¥–∞—Ç–æ–π –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞)
            let displayMessage = message;
            if (selectedDate) {
                displayMessage = `[üìÖ ${selectedDate}] ${message}`;
            }
            addMessage(displayMessage, 'user');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingId = addMessage('–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...', 'ai', true);
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            
            try {
                const response = await fetch('/api/chat/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: message,
                        api_key: apiKey,
                        history: conversationHistory,
                        date: selectedDate  // null –µ—Å–ª–∏ —á–µ–∫–±–æ–∫—Å –≤—ã–∫–ª—é—á–µ–Ω
                    })
                });
                
                const data = await response.json();
                
                // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                removeMessage(loadingId);
                
                if (data.error) {
                    showError(data.error);
                    sendBtn.disabled = false;
                    return;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI
                addMessage(data.answer, 'ai');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
                conversationHistory.push(
                    {'role': 'user', 'content': message},
                    {'role': 'assistant', 'content': data.answer}
                );
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 10 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (5 –ø–∞—Ä –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç)
                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }
                
            } catch (error) {
                removeMessage(loadingId);
                showError('–û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                sendBtn.disabled = false;
            }
        }
        
        function addMessage(text, type, isLoading = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.id = messageId;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            if (isLoading) {
                bubble.className += ' loading-indicator';
            }
            bubble.textContent = text;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = isLoading ? '...' : new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
            
            messageDiv.appendChild(bubble);
            messageDiv.appendChild(timeDiv);
            messagesDiv.appendChild(messageDiv);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return messageId;
        }
        
        function removeMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) {
                message.remove();
            }
        }
        
        function showError(errorText) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = errorText;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function showMessage(text, type) {
            addMessage(text, type);
        }
        
        function clearApiKey() {
            apiKey = '';
            localStorage.removeItem('openai_api_key');
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('apiKeyInput').placeholder = '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à OpenAI API key (sk-...)';
            showMessage('API key –æ—á–∏—â–µ–Ω', 'ai');
        }
        
        function toggleDateSelector() {
            const checkbox = document.getElementById('enableDateAnalysis');
            const dateInput = document.getElementById('dateSelector');
            const clearBtn = document.getElementById('clearDateBtn');
            
            if (checkbox.checked) {
                dateInput.disabled = false;
                dateInput.style.background = 'white';
                dateInput.style.cursor = 'pointer';
                updateDateLabel();
            } else {
                dateInput.disabled = true;
                dateInput.style.background = '#f0f0f0';
                dateInput.style.cursor = 'not-allowed';
                dateInput.value = '';
                clearBtn.style.display = 'none';
            }
        }
        
        function updateDateLabel() {
            const dateInput = document.getElementById('dateSelector');
            const clearBtn = document.getElementById('clearDateBtn');
            const checkbox = document.getElementById('enableDateAnalysis');
            
            if (checkbox.checked && dateInput.value) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }
        }
        
        function clearDate() {
            document.getElementById('dateSelector').value = '';
            document.getElementById('clearDateBtn').style.display = 'none';
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            if (sidebar && overlay) {
                sidebar.classList.toggle('mobile-visible');
                overlay.classList.toggle('active');
            }
        }
        
        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            if (sidebar && overlay) {
                sidebar.classList.remove('mobile-visible');
                overlay.classList.remove('active');
            }
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Å—ã–ª–∫—É –≤ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    closeMobileMenu();
                }
            });
        });
    </script>
</body>
</html>

