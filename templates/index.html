<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>–ê–Ω–∞–ª–∏–∑ WhatsApp —á–∞—Ç–∞</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
        }
        
        /* Hamburger –º–µ–Ω—é */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background: #1e3a5f;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .mobile-overlay.active {
            display: block;
        }
        
        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar {
            width: 260px;
            background: #1e3a5f;
            color: white;
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px 0;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar.mobile-hidden {
            transform: translateX(-100%);
        }
        
        .sidebar-header {
            padding: 0 20px 30px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .sidebar-logo {
            font-size: 24px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
        }
        
        .sidebar-menu li {
            margin: 5px 0;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .sidebar-menu a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .sidebar-menu a.active {
            background: rgba(255,255,255,0.15);
            color: white;
            border-left-color: #4a90e2;
        }
        
        .sidebar-menu a i {
            margin-right: 12px;
            width: 20px;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            margin-left: 260px;
            flex: 1;
            min-height: 100vh;
        }
        
        /* –•–µ–¥–µ—Ä */
        .top-header {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .search-bar {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 300px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #4a90e2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .logout-btn {
            padding: 6px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .content-area {
            padding: 30px;
            background: #f5f5f5;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .page-subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 25px;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-size: 1.5em;
            padding: 50px;
            background: white;
            border-radius: 8px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            touch-action: manipulation;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–∞–ø–æ–≤ */
        .btn, button, input[type="button"], input[type="submit"] {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        input, textarea, select {
            font-size: 16px !important; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç zoom –Ω–∞ iOS */
            touch-action: manipulation;
        }
        
        .stat-card h3 {
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }
        
        .stat-card .unit {
            font-size: 0.8em;
            color: #666;
            margin-left: 5px;
        }
        
        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }
        
        .chart-container.small {
            height: 300px;
        }
        
        .top-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .top-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: transform 0.2s;
        }
        
        .top-item:hover {
            transform: scale(1.02);
            background: #e9ecef;
        }
        
        .top-item .emoji {
            font-size: 2em;
            margin-right: 15px;
        }
        
        .top-item .text {
            flex: 1;
        }
        
        .top-item .word {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .top-item .count {
            color: #667eea;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .author-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .author-card {
            background: #1e3a5f;
            color: white;
            border-radius: 8px;
            padding: 18px;
            border: 1px solid #2a4a6f;
        }
        
        .author-card h4 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .author-card .stat {
            margin: 5px 0;
        }
        
        .refresh-btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #357abd;
        }
        
        .search-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            border-color: #4a90e2;
        }
        
        .search-btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .search-btn:hover {
            background: #357abd;
        }
        
        .search-results {
            display: none;
        }
        
        .search-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-stat-card {
            background: #1e3a5f;
            color: white;
            border-radius: 8px;
            padding: 18px;
            border: 1px solid #2a4a6f;
        }
        
        .search-stat-card h4 {
            margin-bottom: 10px;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .search-stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .match-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .match-item .meta {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        
        .match-item .text {
            color: #333;
            line-height: 1.5;
        }
        
        .interesting-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .interesting-item .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .interesting-item .author {
            color: #667eea;
            font-weight: bold;
        }
        
        .interesting-item .date {
            color: #666;
            font-size: 0.9em;
        }
        
        .interesting-item .text {
            color: #333;
            margin-top: 8px;
            line-height: 1.5;
        }
        
        .interesting-item.clickable {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .interesting-item.clickable:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .match-item {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .match-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .match-item.highlight {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .pagination button {
            background: white;
            border: 1px solid #4a90e2;
            color: #4a90e2;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #4a90e2;
            color: white;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .page-info {
            color: #666;
            font-weight: bold;
        }
        
        .context-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .context-modal.active {
            display: block;
        }
        
        .context-content {
            background: white;
            max-width: 900px;
            margin: 50px auto;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #e0e0e0;
        }
        
        .context-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #1e3a5f;
        }
        
        .context-header h3 {
            color: #1e3a5f;
            margin: 0;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }
        
        .close-btn:hover {
            background: #c82333;
        }
        
        .context-messages {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .context-message {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 3px solid #4a90e2;
            background: #f8f9fa;
        }
        
        .context-message.target {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .context-message .meta {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        
        .context-message .text {
            color: #333;
            line-height: 1.5;
        }
        
    </style>
</head>
<body>
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
    <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>
    <!-- –°–∞–π–¥–±–∞—Ä -->
    <div class="sidebar mobile-hidden" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <span></span>
                <span>ChatAnalyzer</span>
            </div>
        </div>
        <ul class="sidebar-menu">
            <li><a href="/"><span></span> –ê–Ω–∞–ª–∏–∑</a></li>
            <li><a href="/chat"><span></span> AI –ß–∞—Ç</a></li>
            <li style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="padding: 0 20px 10px 20px; color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase;">–†–∞–∑–¥–µ–ª—ã</div>
            </li>
            <li><a href="#" onclick="scrollToSection('overview'); return false;">üìä –û–±–∑–æ—Ä</a></li>
            <li><a href="#" onclick="scrollToSection('activity'); return false;"><span></span> –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</a></li>
            <li><a href="#" onclick="scrollToSection('participants'); return false;"><span></span> –£—á–∞—Å—Ç–Ω–∏–∫–∏</a></li>
            <li><a href="#" onclick="scrollToSection('emoji'); return false;"><span></span> –≠–º–æ–¥–∑–∏</a></li>
            <li><a href="#" onclick="scrollToSection('words'); return false;"><span></span> –°–ª–æ–≤–∞</a></li>
            <li><a href="#" onclick="scrollToSection('search'); return false;"><span></span> –ü–æ–∏—Å–∫</a></li>
            <li><a href="#" onclick="scrollToSection('day-analysis'); return false;"><span></span> –ê–Ω–∞–ª–∏–∑ –¥–Ω—è</a></li>
            <li><a href="#" onclick="scrollToSection('interesting'); return false;"><span></span> –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ</a></li>
            <li><a href="#" onclick="scrollToSection('ghosting'); return false;"><span></span> Ghosting</a></li>
            <li><a href="#" onclick="scrollToSection('heatmap'); return false;"><span></span> Heatmap</a></li>
            <li><a href="#" onclick="scrollToSection('semantic'); return false;"><span></span> –°–µ–º–∞–Ω—Ç–∏–∫–∞</a></li>
            <li><a href="#" onclick="scrollToSection('messageSeries'); return false;"><span></span> –°–µ—Ä–∏–∏</a></li>
            <li><a href="#" onclick="scrollToSection('reactionSpeed'); return false;"><span></span> –†–µ–∞–∫—Ü–∏—è</a></li>
            <li><a href="#" onclick="scrollToSection('participantBalance'); return false;"><span></span> –ë–∞–ª–∞–Ω—Å</a></li>
            <li><a href="#" onclick="scrollToSection('emotional'); return false;"><span></span> –≠–º–æ—Ü–∏–∏</a></li>
            <li><a href="#" onclick="scrollToSection('communicationStyle'); return false;"><span></span> –°—Ç–∏–ª—å</a></li>
            <li><a href="#" onclick="scrollToSection('conflict'); return false;"><span></span> –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã</a></li>
            <li><a href="#" onclick="scrollToSection('seasonality'); return false;"><span></span> –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å</a></li>
        </ul>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-content">
        <!-- –•–µ–¥–µ—Ä -->
        <div class="top-header">
            <div class="header-left">
                <input type="text" class="search-bar" placeholder="–ü–æ–∏—Å–∫..." id="globalSearch">
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar">–û</div>
                    <span>Olzhas</span>
                </div>
                <button class="logout-btn" onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="content-area">
            <div id="loading" class="loading" style="display: none;">
                –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö... ‚è≥
            </div>
            
            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
            <div class="search-section" id="fileUploadSection">
                <h2>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ —á–∞—Ç–∞</h2>
                <p style="color: #666; margin-bottom: 20px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª —á–∞—Ç–∞ WhatsApp (.txt) –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞</p>
                <div class="file-upload-controls">
                    <label for="fileInput" class="file-input-label">
                        <input type="file" id="fileInput" accept=".txt" class="file-input" style="display: none;">
                        <span class="file-input-button">üìÅ –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª (.txt)</span>
                    </label>
                    <button class="btn primary" onclick="uploadFile()" style="width: 100%; padding: 15px; font-size: 16px; min-height: 50px;">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn secondary" onclick="switchToDefault()" style="width: 100%; padding: 15px; font-size: 16px; min-height: 50px;">üîÑ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∞–π–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
                </div>
                <div id="uploadStatus" style="margin-top: 15px;"></div>
                <style>
                    .file-input-label {
                        display: block;
                        width: 100%;
                        margin-bottom: 15px;
                        cursor: pointer;
                    }
                    .file-input-button {
                        display: block;
                        width: 100%;
                        padding: 20px;
                        background: #f0f0f0;
                        border: 2px dashed #4a90e2;
                        border-radius: 8px;
                        text-align: center;
                        cursor: pointer;
                        font-size: 16px;
                        transition: all 0.3s;
                        color: #1e3a5f;
                        font-weight: 500;
                    }
                    .file-input-button:hover {
                        background: #e0e0e0;
                        border-color: #357abd;
                    }
                    .file-input-button:active {
                        background: #d0d0d0;
                    }
                    @media (max-width: 768px) {
                        .file-input-button {
                            padding: 25px;
                            font-size: 18px;
                            min-height: 70px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                    }
                </style>
            </div>
            
            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ -->
            <div id="contextModal" class="context-modal" onclick="if(event.target.id === 'contextModal') closeContext()">
                <div class="context-content" onclick="event.stopPropagation()">
                    <div class="context-header">
                        <h3>üìã –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
                        <button class="close-btn" onclick="closeContext()">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                    <div id="contextMessages" class="context-messages"></div>
                </div>
            </div>
            
            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–Ω—è -->
            <div id="dayAnalysisModal" class="context-modal" onclick="if(event.target.id === 'dayAnalysisModal') closeDayAnalysis()">
                <div class="context-content" style="max-width: 1200px;" onclick="event.stopPropagation()">
                    <div class="context-header">
                        <h3 id="dayAnalysisTitle">üìÖ –ê–Ω–∞–ª–∏–∑ –¥–Ω—è</h3>
                        <button class="close-btn" onclick="closeDayAnalysis()">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                    <div id="dayAnalysisContent" style="max-height: 80vh; overflow-y: auto;"></div>
                </div>
            </div>
            
            <div id="content" style="display: none;">
                <div class="page-title">–ê–Ω–∞–ª–∏–∑ WhatsApp —á–∞—Ç–∞</div>
                <div class="page-subtitle">–ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤–∞—à–µ–≥–æ —á–∞—Ç–∞</div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="refresh-btn" onclick="refreshData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
                    <button class="refresh-btn" onclick="showFileUpload()" style="background: #28a745;">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª</button>
                    <div id="currentFileInfo" style="background: white; padding: 10px 15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; border: 1px solid #e0e0e0;">
                        <span style="color: #1e3a5f; font-weight: 500; font-size: 14px;">–¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª:</span>
                        <span id="currentFileName" style="color: #666; font-size: 14px;">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                </div>
            
            <!-- –ü–æ–∏—Å–∫ —Å–ª–æ–≤–∞ -->
            <div class="search-section" id="search">
                <h2>üîç –ü–æ–∏—Å–∫ —Å–ª–æ–≤–∞</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞..." onkeypress="if(event.key==='Enter') searchWord()">
                    <button class="search-btn" onclick="searchWord()">–ù–∞–π—Ç–∏</button>
                </div>
                <div id="searchResults" class="search-results">
                    <div id="searchStats" class="search-stats"></div>
                    <div id="searchMatches"></div>
                    <div id="searchPagination" class="pagination"></div>
                </div>
            </div>
            
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="section" id="overview">
                <h2>üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="stats-grid" id="basicStats"></div>
            </div>
            
            <!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
            <div class="section" id="activity">
                <h2>‚è∞ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h2>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="weekdayChart"></canvas>
                </div>
                <div class="chart-container small">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º -->
            <div class="section" id="participants">
                <h2>üë• –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º</h2>
                <div id="authorStats"></div>
            </div>
            
            <!-- –¢–æ–ø —ç–º–æ–¥–∑–∏ -->
            <div class="section" id="emoji">
                <h2>üòä –¢–æ–ø —ç–º–æ–¥–∑–∏/—Å–º–∞–π–ª–∏–∫–æ–≤</h2>
                <div id="emojiStats"></div>
                <div class="top-items" id="topEmojis"></div>
            </div>
            
            <!-- –¢–æ–ø —Å–ª–æ–≤ -->
            <div class="section" id="words">
                <h2>üìù –¢–æ–ø —Å–ª–æ–≤</h2>
                <div class="top-items" id="topWords"></div>
            </div>
            
            <!-- –î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div class="section">
                <h2>üìè –î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</h2>
                <div class="chart-container">
                    <canvas id="lengthChart"></canvas>
                </div>
            </div>
            
            <!-- –í—ã–±–æ—Ä –¥–∞—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ -->
            <div class="search-section" id="day-analysis">
                <h2>üìÖ –ê–Ω–∞–ª–∏–∑ –¥–Ω—è</h2>
                <div class="search-box">
                    <input type="date" id="dateInput" class="search-input">
                    <button class="search-btn" onclick="analyzeDay()">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–µ–Ω—å</button>
                </div>
            </div>
            
            <!-- –ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="section" id="interesting" style="display: none;">
                <h2>üåü –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã</h2>
                <div id="interestingStats"></div>
            </div>
            
            <!-- Ghosting –∞–Ω–∞–ª–∏–∑ -->
            <div class="section" id="ghosting">
                <h2>üëª Ghosting –∞–Ω–∞–ª–∏–∑</h2>
                <div id="ghostingStats"></div>
            </div>
            
            <!-- Activity Heatmap -->
            <div class="section" id="heatmap">
                <h2>üî• –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
                <div id="heatmapContainer"></div>
            </div>
            
            <!-- Semantic –∞–Ω–∞–ª–∏–∑ -->
            <div class="section" id="semantic">
                <h2>üß† –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑</h2>
                <div id="semanticStats"></div>
            </div>
            
            <!-- –°–µ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div class="section" id="messageSeries">
                <h2>üì® –°–µ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</h2>
                <div id="messageSeriesStats"></div>
            </div>
            
            <!-- –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏ -->
            <div class="section" id="reactionSpeed">
                <h2>‚ö° –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∞–∫—Ü–∏–∏</h2>
                <div id="reactionSpeedStats"></div>
            </div>
            
            <!-- –ë–∞–ª–∞–Ω—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <div class="section" id="participantBalance">
                <h2>‚öñÔ∏è –ë–∞–ª–∞–Ω—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
                <div id="participantBalanceStats"></div>
            </div>
            
            <!-- –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ -->
            <div class="section" id="emotional">
                <h2>üòä –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h2>
                <div id="emotionalStats"></div>
            </div>
            
            <!-- –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è -->
            <div class="section" id="communicationStyle">
                <h2>üí¨ –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è</h2>
                <div id="communicationStyleStats"></div>
            </div>
            
            <!-- –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ -->
            <div class="section" id="conflict">
                <h2>‚öîÔ∏è –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤</h2>
                <div id="conflictStats"></div>
            </div>
            
            <!-- –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å -->
            <div class="section" id="seasonality">
                <h2>üìÖ –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –∏ –¥–∏–Ω–∞–º–∏–∫–∞</h2>
                <div id="seasonalityStats"></div>
            </div>
            </div>
        </div>
    </div>
    
    <script>
        let charts = {};
        let allSearchMatches = [];  // –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        let currentPage = 1;
        const itemsPerPage = 50;  // –°–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        
        async function loadData() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Ñ–∞–π–ª–µ
                const fileInfo = await updateCurrentFileInfo();
                
                // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏
                if (!fileInfo.is_loaded) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('fileUploadSection').style.display = 'block';
                    return;
                }
                
                const response = await fetch('/api/analysis');
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('loading').innerHTML = 
                        '<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞: ' + data.error + '</div>';
                    document.getElementById('fileUploadSection').style.display = 'block';
                    return;
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                renderAnalysis(data);
            } catch (error) {
                document.getElementById('loading').innerHTML = 
                    '<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</div>';
                document.getElementById('fileUploadSection').style.display = 'block';
            }
        }
        
        function renderAnalysis(data) {
            renderBasicStats(data.basic);
            renderActivityCharts(data.activity);
            renderAuthorStats(data.basic);
            renderEmojiStats(data.emoji);
            renderWordStats(data.words);
            renderLengthStats(data.message_length, data.basic);
            if (data.interesting) {
                renderInterestingStats(data.interesting);
            }
            if (data.ghosting) {
                renderGhostingStats(data.ghosting);
            }
            if (data.activity_heatmap) {
                renderActivityHeatmap(data.activity_heatmap);
            }
            if (data.semantic) {
                renderSemanticAnalysis(data.semantic);
            }
            if (data.message_series) {
                renderMessageSeries(data.message_series);
            }
            if (data.reaction_speed) {
                renderReactionSpeed(data.reaction_speed);
            }
            if (data.participant_balance) {
                renderParticipantBalance(data.participant_balance);
            }
            if (data.emotional) {
                renderEmotionalAnalysis(data.emotional);
            }
            if (data.communication_style) {
                renderCommunicationStyle(data.communication_style);
            }
            if (data.conflict) {
                renderConflictAnalysis(data.conflict);
            }
            if (data.seasonality) {
                renderSeasonality(data.seasonality);
            }
        }
        
        function renderBasicStats(basic) {
            const statsHtml = `
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                    <div class="value">${basic.total_messages.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ —Å–ª–æ–≤</h3>
                    <div class="value">${basic.total_words.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <h3>–î–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
                    <div class="value">${basic.days_active}</div>
                </div>
                <div class="stat-card">
                    <h3>–°–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å</h3>
                    <div class="value">${basic.messages_per_day.toFixed(1)}</div>
                </div>
                <div class="stat-card">
                    <h3>–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞</h3>
                    <div class="value">${basic.avg_message_length.toFixed(0)}<span class="unit">—Å–∏–º–≤–æ–ª–æ–≤</span></div>
                </div>
                <div class="stat-card">
                    <h3>–°—Ä–µ–¥–Ω–µ–µ —Å–ª–æ–≤</h3>
                    <div class="value">${basic.avg_words_per_message.toFixed(1)}</div>
                </div>
            `;
            document.getElementById('basicStats').innerHTML = statsHtml;
        }
        
        function renderActivityCharts(activity) {
            // –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º
            const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
            if (charts.hourly) charts.hourly.destroy();
            charts.hourly = new Chart(hourlyCtx, {
                type: 'bar',
                data: {
                    labels: activity.hourly.map(h => h[0] + ':00'),
                    datasets: [{
                        label: '–°–æ–æ–±—â–µ–Ω–∏–π',
                        data: activity.hourly.map(h => h[1]),
                        borderColor: '#4a90e2',
                        backgroundColor: '#4a90e2',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const element = elements[0];
                            const hour = element.index;
                            showMessagesByHour(hour);
                        }
                    },
                    onHover: (event, elements) => {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
            const weekdayCtx = document.getElementById('weekdayChart').getContext('2d');
            if (charts.weekday) charts.weekday.destroy();
            charts.weekday = new Chart(weekdayCtx, {
                type: 'bar',
                data: {
                    labels: activity.weekday.map(w => w[0]),
                    datasets: [{
                        label: '–°–æ–æ–±—â–µ–Ω–∏–π',
                        data: activity.weekday.map(w => w[1]),
                        backgroundColor: '#1e3a5f',
                        borderColor: '#4a90e2',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const element = elements[0];
                            const weekdayIndex = element.index;
                            const weekdayNames = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
                            alert(`–ö–ª–∏–∫ –ø–æ –¥–Ω—é –Ω–µ–¥–µ–ª–∏: ${weekdayNames[weekdayIndex]}\n–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É –≤ —Ä–∞–∑–¥–µ–ª–µ "–ê–Ω–∞–ª–∏–∑ –¥–Ω—è"`);
                        }
                    },
                    onHover: (event, elements) => {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ –ø–æ –º–µ—Å—è—Ü–∞–º
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            if (charts.monthly) charts.monthly.destroy();
            charts.monthly = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: activity.monthly.map(m => m[0]),
                    datasets: [{
                        label: '–°–æ–æ–±—â–µ–Ω–∏–π',
                        data: activity.monthly.map(m => m[1]),
                        backgroundColor: '#f093fb',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        function renderAuthorStats(basic) {
            const authors = Object.keys(basic.author_stats);
            const statsHtml = authors.map(author => {
                const messages = basic.author_stats[author];
                const chars = basic.author_chars[author];
                const percentage = ((messages / basic.total_messages) * 100).toFixed(1);
                
                return `
                    <div class="author-card">
                        <h4>${author}</h4>
                        <div class="stat">–°–æ–æ–±—â–µ–Ω–∏–π: ${messages.toLocaleString()}</div>
                        <div class="stat">–°–∏–º–≤–æ–ª–æ–≤: ${chars.toLocaleString()}</div>
                        <div class="stat">–î–æ–ª—è: ${percentage}%</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('authorStats').innerHTML = 
                `<div class="author-stats">${statsHtml}</div>`;
        }
        
        function renderEmojiStats(emoji) {
            const statsHtml = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ —ç–º–æ–¥–∑–∏</h3>
                        <div class="value">${emoji.total_emojis.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö</h3>
                        <div class="value">${emoji.unique_emojis}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–°–æ–æ–±—â–µ–Ω–∏–π —Å —ç–º–æ–¥–∑–∏</h3>
                        <div class="value">${emoji.messages_with_emoji.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–ü—Ä–æ—Ü–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h3>
                        <div class="value">${emoji.emoji_usage_percentage.toFixed(1)}<span class="unit">%</span></div>
                    </div>
                </div>
            `;
            document.getElementById('emojiStats').innerHTML = statsHtml;
            
            const topEmojisHtml = emoji.top_emojis.slice(0, 30).map(item => `
                <div class="top-item">
                    <span class="emoji">${item[0]}</span>
                    <div class="text">
                        <div class="word">–≠–º–æ–¥–∑–∏</div>
                    </div>
                    <div class="count">${item[1]}</div>
                </div>
            `).join('');
            document.getElementById('topEmojis').innerHTML = topEmojisHtml;
        }
        
        function renderWordStats(words) {
            const topWordsHtml = words.top_words.slice(0, 30).map(item => `
                <div class="top-item">
                    <div class="text">
                        <div class="word">${item[0]}</div>
                    </div>
                    <div class="count">${item[1]}</div>
                </div>
            `).join('');
            document.getElementById('topWords').innerHTML = topWordsHtml;
        }
        
        function renderLengthStats(length, basic) {
            const authors = Object.keys(basic.author_stats);
            const lengthCtx = document.getElementById('lengthChart').getContext('2d');
            
            if (charts.length) charts.length.destroy();
            charts.length = new Chart(lengthCtx, {
                type: 'bar',
                data: {
                    labels: authors,
                    datasets: [{
                        label: '–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–∏–º–≤–æ–ª–æ–≤)',
                        data: authors.map(a => length.author_avg_lengths[a] || 0),
                        backgroundColor: authors.map((_, i) => 
                            i === 0 ? '#667eea' : '#764ba2'
                        ),
                        borderColor: authors.map((_, i) => 
                            i === 0 ? '#5568d3' : '#653888'
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        async function refreshData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
            
            try {
                await fetch('/api/refresh');
                await loadData();
            } catch (error) {
                document.getElementById('loading').innerHTML = 
                    '<div style="color: red;">–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error.message + '</div>';
            }
        }
        
        async function searchWord() {
            const word = document.getElementById('searchInput').value.trim();
            if (!word) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div class="loading" style="color: #667eea;">–ü–æ–∏—Å–∫...</div>';
            
            try {
                const response = await fetch(`/api/search?word=${encodeURIComponent(word)}`);
                const data = await response.json();
                
                if (data.error) {
                    resultsDiv.innerHTML = `<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                    return;
                }
                
                renderSearchResults(data);
            } catch (error) {
                resultsDiv.innerHTML = `<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}</div>`;
            }
        }
        
        function renderSearchResults(data) {
            const statsHtml = `
                <div class="search-stat-card">
                    <h4>–í—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</h4>
                    <div class="value">${data.total_occurrences}</div>
                </div>
                <div class="search-stat-card">
                    <h4>–í —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</h4>
                    <div class="value">${data.unique_messages}</div>
                </div>
                <div class="search-stat-card">
                    <h4>–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ</h4>
                    <div class="value">${data.total_matches_count}</div>
                </div>
            `;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞–≤—Ç–æ—Ä–∞–º
            const authors = Object.keys(data.author_stats);
            let authorStatsHtml = '';
            if (authors.length > 0) {
                authorStatsHtml = '<h3 style="margin: 20px 0 10px 0; color: #667eea;">–ü–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º:</h3><div class="author-stats">';
                authors.forEach(author => {
                    const count = data.author_stats[author];
                    const percentage = data.author_percentages[author] || 0;
                    authorStatsHtml += `
                        <div class="author-card">
                            <h4>${author}</h4>
                            <div class="stat">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π: ${count}</div>
                            <div class="stat">% —Å–æ–æ–±—â–µ–Ω–∏–π: ${percentage}%</div>
                        </div>
                    `;
                });
                authorStatsHtml += '</div>';
            }
            
            // –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º
            let chartHtml = '';
            if (data.hour_stats && data.hour_stats.length > 0) {
                chartHtml = '<div class="chart-container small" style="margin: 20px 0;"><canvas id="searchHourlyChart"></canvas></div>';
                setTimeout(() => {
                    const ctx = document.getElementById('searchHourlyChart')?.getContext('2d');
                    if (ctx) {
                        if (charts.searchHourly) charts.searchHourly.destroy();
                        charts.searchHourly = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: data.hour_stats.map(h => h[0] + ':00'),
                                datasets: [{
                                    label: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π',
                                    data: data.hour_stats.map(h => h[1]),
                                    backgroundColor: '#667eea',
                                    borderColor: '#764ba2',
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    y: { beginAtZero: true }
                                }
                            }
                        });
                    }
                }, 100);
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            allSearchMatches = data.matches || [];
            currentPage = 1;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–∏ - —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É HTML
            document.getElementById('searchResults').innerHTML = 
                `<div id="searchStats" class="search-stats">${statsHtml}</div>
                ${authorStatsHtml}
                ${chartHtml}
                <h3 style="margin: 20px 0 10px 0; color: #667eea;">–í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (${allSearchMatches.length}):</h3>
                <div id="searchMatches"></div>
                <div id="searchPagination" class="pagination"></div>`;
            
            // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–æ–±—â–µ–Ω–∏–π
            renderMatchesPage();
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function renderMatchesPage() {
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageMatches = allSearchMatches.slice(startIdx, endIdx);
            
            const matchesHtml = pageMatches.map((match, idx) => {
                const date = new Date(match.datetime);
                const safeDatetime = match.datetime.replace(/'/g, "\\'");
                return `
                    <div class="match-item" onclick="showContext('${safeDatetime}')">
                        <div class="meta">
                            <strong>${escapeHtml(match.author)}</strong> ‚Ä¢ ${date.toLocaleString('ru-RU')}
                            ${match.count > 1 ? ` ‚Ä¢ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${match.count} —Ä–∞–∑` : ''}
                        </div>
                        <div class="text">${escapeHtml(match.text)}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('searchMatches').innerHTML = matchesHtml || '<div style="text-align: center; padding: 20px; color: #666;">–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            
            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            const totalPages = Math.ceil(allSearchMatches.length / itemsPerPage);
            let paginationHtml = '';
            
            if (totalPages > 1) {
                paginationHtml = `
                    <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
                    <span class="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}</span>
                    <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>–°–ª–µ–¥—É—é—â–∞—è ‚ñ∂</button>
                    <div style="margin-top: 10px; color: #666; font-size: 0.9em;">
                        –ü–æ–∫–∞–∑–∞–Ω–æ ${startIdx + 1}-${Math.min(endIdx, allSearchMatches.length)} –∏–∑ ${allSearchMatches.length} —Å–æ–æ–±—â–µ–Ω–∏–π
                    </div>
                `;
            }
            
            document.getElementById('searchPagination').innerHTML = paginationHtml;
        }
        
        function changePage(page) {
            const totalPages = Math.ceil(allSearchMatches.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderMatchesPage();
            document.getElementById('searchMatches').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        async function showContext(datetime) {
            const modal = document.getElementById('contextModal');
            const messagesDiv = document.getElementById('contextMessages');
            
            modal.classList.add('active');
            messagesDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #667eea;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞...</div>';
            
            try {
                const response = await fetch(`/api/context?datetime=${encodeURIComponent(datetime)}&context_size=10`);
                const data = await response.json();
                
                if (data.error) {
                    messagesDiv.innerHTML = `<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                    return;
                }
                
                const messagesHtml = data.messages.map((msg, idx) => {
                    const date = new Date(msg.datetime);
                    const isTarget = idx === data.target_index;
                    return `
                        <div class="context-message ${isTarget ? 'target' : ''}">
                            <div class="meta">
                                <strong>${msg.author}</strong> ‚Ä¢ ${date.toLocaleString('ru-RU')}
                                ${isTarget ? ' <span style="color: #ffc107; font-weight: bold;">[–í—ã–±—Ä–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]</span>' : ''}
                            </div>
                            <div class="text">${escapeHtml(msg.text)}</div>
                        </div>
                    `;
                }).join('');
                
                messagesDiv.innerHTML = messagesHtml;
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
                const targetMsg = messagesDiv.querySelector('.target');
                if (targetMsg) {
                    setTimeout(() => {
                        targetMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            } catch (error) {
                messagesDiv.innerHTML = `<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: ${error.message}</div>`;
            }
        }
        
        function closeContext() {
            document.getElementById('contextModal').classList.remove('active');
        }
        
        async function analyzeDay() {
            const dateInput = document.getElementById('dateInput');
            const date = dateInput.value;
            
            if (!date) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
                return;
            }
            
            showDayAnalysis(date);
        }
        
        async function showDayAnalysis(date) {
            const modal = document.getElementById('dayAnalysisModal');
            const contentDiv = document.getElementById('dayAnalysisContent');
            const titleDiv = document.getElementById('dayAnalysisTitle');
            
            modal.classList.add('active');
            titleDiv.textContent = `üìÖ –ê–Ω–∞–ª–∏–∑ –¥–Ω—è: ${new Date(date + 'T00:00:00').toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            contentDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #667eea;">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–Ω—è...</div>';
            
            try {
                const response = await fetch(`/api/day_analysis?date=${encodeURIComponent(date)}`);
                const data = await response.json();
                
                if (data.error) {
                    contentDiv.innerHTML = `<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                    return;
                }
                
                renderDayAnalysis(data);
            } catch (error) {
                contentDiv.innerHTML = `<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞: ${error.message}</div>`;
            }
        }
        
        function renderDayAnalysis(data) {
            const contentDiv = document.getElementById('dayAnalysisContent');
            let html = '';
            
            // –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const basic = data.basic || {};
            html += `
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                        <div class="value">${basic.total_messages || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ —Å–ª–æ–≤</h3>
                        <div class="value">${basic.total_words || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞</h3>
                        <div class="value">${(basic.avg_message_length || 0).toFixed(0)}<span class="unit">—Å–∏–º–≤–æ–ª–æ–≤</span></div>
                    </div>
                    <div class="stat-card">
                        <h3>–ü–µ—Ä–∏–æ–¥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
                        <div class="value" style="font-size: 1.2em;">
                            ${data.first_message_time || '‚Äî'} - ${data.last_message_time || '‚Äî'}
                        </div>
                    </div>
                </div>
            `;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
            if (basic.author_stats) {
                const authors = Object.keys(basic.author_stats);
                html += '<h3 style="margin: 20px 0 10px 0; color: #667eea;">üë• –ü–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º:</h3>';
                html += '<div class="author-stats">';
                authors.forEach(author => {
                    const messages = basic.author_stats[author];
                    const chars = basic.author_chars[author] || 0;
                    const percentage = ((messages / basic.total_messages) * 100).toFixed(1);
                    html += `
                        <div class="author-card">
                            <h4>${escapeHtml(author)}</h4>
                            <div class="stat">–°–æ–æ–±—â–µ–Ω–∏–π: ${messages}</div>
                            <div class="stat">–°–∏–º–≤–æ–ª–æ–≤: ${chars}</div>
                            <div class="stat">–î–æ–ª—è: ${percentage}%</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // –¢–æ–ø —ç–º–æ–¥–∑–∏
            if (data.emoji && data.emoji.top_emojis && data.emoji.top_emojis.length > 0) {
                html += '<h3 style="margin: 30px 0 10px 0; color: #667eea;">üòä –¢–æ–ø —ç–º–æ–¥–∑–∏:</h3>';
                html += '<div class="top-items">';
                data.emoji.top_emojis.slice(0, 15).forEach(item => {
                    html += `
                        <div class="top-item">
                            <span class="emoji">${item[0]}</span>
                            <div class="text"><div class="word">–≠–º–æ–¥–∑–∏</div></div>
                            <div class="count">${item[1]}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // –¢–æ–ø —Å–ª–æ–≤
            if (data.words && data.words.top_words && data.words.top_words.length > 0) {
                html += '<h3 style="margin: 30px 0 10px 0; color: #667eea;">üìù –¢–æ–ø —Å–ª–æ–≤:</h3>';
                html += '<div class="top-items">';
                data.words.top_words.slice(0, 20).forEach(item => {
                    html += `
                        <div class="top-item">
                            <div class="text"><div class="word">${escapeHtml(item[0])}</div></div>
                            <div class="count">${item[1]}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º
            if (data.activity && data.activity.hourly && data.activity.hourly.length > 0) {
                html += '<h3 style="margin: 30px 0 10px 0; color: #667eea;">‚è∞ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º:</h3>';
                html += '<div class="chart-container small"><canvas id="dayHourlyChart"></canvas></div>';
                
                setTimeout(() => {
                    const ctx = document.getElementById('dayHourlyChart')?.getContext('2d');
                    if (ctx) {
                        if (charts.dayHourly) charts.dayHourly.destroy();
                        charts.dayHourly = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: data.activity.hourly.map(h => h[0] + ':00'),
                                datasets: [{
                                    label: '–°–æ–æ–±—â–µ–Ω–∏–π',
                                    data: data.activity.hourly.map(h => h[1]),
                                    backgroundColor: '#4a90e2',
                                    borderColor: '#1e3a5f',
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    y: { beginAtZero: true }
                                },
                                onClick: (event, elements) => {
                                    if (elements.length > 0) {
                                        const element = elements[0];
                                        const hour = element.index;
                                        const date = data.date;
                                        showMessagesByHourAndDate(hour, date);
                                    }
                                },
                                onHover: (event, elements) => {
                                    event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                                }
                            }
                        });
                    }
                }, 100);
            }
            
            // –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–Ω—è
            if (data.messages && data.messages.length > 0) {
                html += '<h3 style="margin: 30px 0 10px 0; color: #667eea;">üí¨ –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–Ω—è (${data.messages.length}):</h3>';
                html += '<div class="context-messages" style="max-height: 400px;">';
                data.messages.forEach(msg => {
                    const date = new Date(msg.datetime);
                    html += `
                        <div class="context-message">
                            <div class="meta">
                                <strong>${escapeHtml(msg.author)}</strong> ‚Ä¢ ${date.toLocaleString('ru-RU')}
                            </div>
                            <div class="text">${escapeHtml(msg.text)}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            contentDiv.innerHTML = html;
        }
        
        function closeDayAnalysis() {
            document.getElementById('dayAnalysisModal').classList.remove('active');
        }
        
        async function showMessagesByHour(hour) {
            const modal = document.getElementById('dayAnalysisModal');
            const contentDiv = document.getElementById('dayAnalysisContent');
            const titleDiv = document.getElementById('dayAnalysisTitle');
            
            modal.classList.add('active');
            titleDiv.textContent = `üí¨ –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞ ${hour}:00`;
            contentDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #667eea;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
            
            try {
                const response = await fetch(`/api/messages_by_hour?hour=${hour}`);
                const data = await response.json();
                
                renderMessagesByHour(data, hour, null);
            } catch (error) {
                contentDiv.innerHTML = `<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }
        
        async function showMessagesByHourAndDate(hour, date) {
            const modal = document.getElementById('dayAnalysisModal');
            const contentDiv = document.getElementById('dayAnalysisContent');
            const titleDiv = document.getElementById('dayAnalysisTitle');
            
            modal.classList.add('active');
            const dateStr = new Date(date + 'T00:00:00').toLocaleDateString('ru-RU');
            titleDiv.textContent = `üí¨ –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞ ${hour}:00 (${dateStr})`;
            contentDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #667eea;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
            
            try {
                const response = await fetch(`/api/messages_by_hour?hour=${hour}&date=${date}`);
                const data = await response.json();
                
                renderMessagesByHour(data, hour, date);
            } catch (error) {
                contentDiv.innerHTML = `<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }
        
        function renderMessagesByHour(data, hour, date) {
            const contentDiv = document.getElementById('dayAnalysisContent');
            
            if (data.error) {
                contentDiv.innerHTML = `<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                return;
            }
            
            let html = `
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                        <div class="value">${data.total_messages}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–í—Ä–µ–º—è</h3>
                        <div class="value" style="font-size: 1.5em;">${hour}:00</div>
                    </div>
                </div>
            `;
            
            if (data.messages && data.messages.length > 0) {
                html += '<h3 style="margin: 20px 0 10px 0; color: #1e3a5f;">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è:</h3>';
                html += '<div class="context-messages" style="max-height: 500px;">';
                data.messages.forEach(msg => {
                    const dateObj = new Date(msg.datetime);
                    html += `
                        <div class="context-message">
                            <div class="meta">
                                <strong>${escapeHtml(msg.author)}</strong> ‚Ä¢ ${dateObj.toLocaleString('ru-RU')}
                            </div>
                            <div class="text">${escapeHtml(msg.text)}</div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<div style="text-align: center; padding: 20px; color: #666;">–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            }
            
            contentDiv.innerHTML = html;
        }
        
        function renderInterestingStats(interesting) {
            document.getElementById('interesting').style.display = 'block';
            
            let html = '';
            
            // –°–∞–º—ã–µ –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (interesting.longest_messages && interesting.longest_messages.length > 0) {
                html += '<h3 style="margin: 20px 0 10px 0; color: #667eea;">üìè –°–∞–º—ã–µ –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:</h3>';
                interesting.longest_messages.forEach(msg => {
                    html += `
                        <div class="interesting-item">
                            <div class="header">
                                <span class="author">${msg.author}</span>
                                <span class="date">${new Date(msg.date).toLocaleDateString('ru-RU')} ‚Ä¢ ${msg.length} —Å–∏–º–≤–æ–ª–æ–≤</span>
                            </div>
                            <div class="text">${escapeHtml(msg.text)}</div>
                        </div>
                    `;
                });
            }
            
            // –°–∞–º—ã–µ –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (interesting.shortest_messages && interesting.shortest_messages.length > 0) {
                html += '<h3 style="margin: 20px 0 10px 0; color: #667eea;">‚úÇÔ∏è –°–∞–º—ã–µ –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:</h3>';
                interesting.shortest_messages.forEach(msg => {
                    html += `
                        <div class="interesting-item">
                            <div class="header">
                                <span class="author">${msg.author}</span>
                                <span class="date">${new Date(msg.date).toLocaleDateString('ru-RU')} ‚Ä¢ ${msg.length} —Å–∏–º–≤–æ–ª–æ–≤</span>
                            </div>
                            <div class="text">${escapeHtml(msg.text)}</div>
                        </div>
                    `;
                });
            }
            
            // –¢–æ–ø –¥–Ω–µ–π –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            if (interesting.top_active_days && interesting.top_active_days.length > 0) {
                html += '<h3 style="margin: 20px 0 10px 0; color: #667eea;">üî• –°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–Ω–∏ (–∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞):</h3>';
                interesting.top_active_days.forEach(day => {
                    const dateStr = new Date(day.date).toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    html += `
                        <div class="interesting-item clickable" onclick="showDayAnalysis('${day.date}')">
                            <div class="header">
                                <span class="author">${dateStr}</span>
                                <span class="date">${day.messages} —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            // –ü–µ—Ä–≤–æ–µ –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (interesting.author_first_message) {
                html += '<h3 style="margin: 20px 0 10px 0; color: #667eea;">üé¨ –ü–µ—Ä–≤—ã–µ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:</h3>';
                Object.keys(interesting.author_first_message).forEach(author => {
                    const first = interesting.author_first_message[author];
                    const last = interesting.author_last_message[author];
                    html += `
                        <div class="interesting-item">
                            <div class="header">
                                <span class="author">${author}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                                <div>
                                    <strong style="color: #667eea;">–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</strong><br>
                                    <span style="color: #666; font-size: 0.9em;">${new Date(first.datetime).toLocaleString('ru-RU')}</span><br>
                                    <span style="color: #333;">${escapeHtml(first.text)}</span>
                                </div>
                                <div>
                                    <strong style="color: #764ba2;">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</strong><br>
                                    <span style="color: #666; font-size: 0.9em;">${new Date(last.datetime).toLocaleString('ru-RU')}</span><br>
                                    <span style="color: #333;">${escapeHtml(last.text)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            // –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
            if (interesting.avg_response_time_minutes > 0) {
                html += `
                    <div class="stat-card" style="margin-top: 20px;">
                        <h3>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</h3>
                        <div class="value">${interesting.avg_response_time_minutes.toFixed(1)}<span class="unit">–º–∏–Ω—É—Ç</span></div>
                        <div style="margin-top: 10px; color: #666; font-size: 0.9em;">
                            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${interesting.total_responses_analyzed} –æ—Ç–≤–µ—Ç–æ–≤
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('interestingStats').innerHTML = html;
        }
        
        function renderGhostingStats(ghosting) {
            if (!ghosting || !ghosting.top_ghosting_events || ghosting.top_ghosting_events.length === 0) {
                document.getElementById('ghostingStats').innerHTML = '<p style="color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ ghosting —Å–æ–±—ã—Ç–∏—è—Ö</p>';
                return;
            }
            
            let html = '';
            
            html += `<div style="margin-bottom: 20px;">
                <h3 style="color: #667eea; margin-bottom: 10px;">–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π ghosting: ${ghosting.total_ghosting_events}</h3>
            </div>`;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
            if (ghosting.author_stats) {
                html += '<h3 style="color: #667eea; margin: 20px 0 10px 0;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º:</h3>';
                html += '<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">';
                for (const [author, stats] of Object.entries(ghosting.author_stats)) {
                    html += `
                        <div class="stat-card">
                            <div class="stat-value">${stats.ghosting_count}</div>
                            <div class="stat-label">${escapeHtml(author)}</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                –°—Ä–µ–¥–Ω–µ–µ: ${stats.avg_hours_silent}—á<br>
                                –ú–∞–∫—Å: ${stats.max_hours_silent}—á
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
            }
            
            // –¢–æ–ø —Å–æ–±—ã—Ç–∏–π
            if (ghosting.top_ghosting_events && ghosting.top_ghosting_events.length > 0) {
                html += '<h3 style="color: #667eea; margin: 20px 0 10px 0;">‚è±Ô∏è –¢–æ–ø —Å–∞–º—ã—Ö –¥–æ–ª–≥–∏—Ö –ø–µ—Ä–∏–æ–¥–æ–≤ –º–æ–ª—á–∞–Ω–∏—è:</h3>';
                ghosting.top_ghosting_events.slice(0, 10).forEach((event, idx) => {
                    const fromDate = new Date(event.ghosted_from).toLocaleString('ru-RU');
                    const toDate = new Date(event.responded_at).toLocaleString('ru-RU');
                    html += `
                        <div class="interesting-item" style="margin-bottom: 15px;">
                            <div class="header">
                                <span class="author">${idx + 1}. ${escapeHtml(event.ghosted_by)} ‚Üí ${escapeHtml(event.responded_by)}</span>
                                <span class="date">${event.days_silent} –¥–Ω–µ–π (${event.hours_silent} —á–∞—Å–æ–≤)</span>
                            </div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                –ú–æ–ª—á–∞–Ω–∏–µ —Å: ${fromDate}<br>
                                –û—Ç–≤–µ—Ç –≤: ${toDate}
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('ghostingStats').innerHTML = html;
        }
        
        function renderActivityHeatmap(heatmap) {
            if (!heatmap || !heatmap.heatmap) {
                document.getElementById('heatmapContainer').innerHTML = '<p style="color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã</p>';
                return;
            }
            
            let html = '';
            
            // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
            let maxValue = 0;
            heatmap.heatmap.forEach(day => {
                day.hours.forEach(hour => {
                    maxValue = Math.max(maxValue, hour.count);
                });
            });
            
            html += '<div style="margin-bottom: 20px;">';
            html += '<h3 style="color: #667eea; margin-bottom: 10px;">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ –∏ —á–∞—Å–∞–º</h3>';
            html += '<div style="display: grid; grid-template-columns: 120px repeat(24, 1fr); gap: 2px; margin-top: 20px; font-size: 11px; overflow-x: auto;">';
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —á–∞—Å–∞–º–∏
            html += '<div></div>';
            for (let h = 0; h < 24; h++) {
                html += `<div style="text-align: center; padding: 5px; background: #f0f0f0; font-weight: bold;">${h}</div>`;
            }
            
            // –î–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º
            heatmap.heatmap.forEach(day => {
                html += `<div style="padding: 10px; background: #f0f0f0; font-weight: bold; text-align: right;">${day.weekday_name}</div>`;
                day.hours.forEach(hour => {
                    const intensity = maxValue > 0 ? (hour.count / maxValue) : 0;
                    const opacity = Math.max(0.1, intensity);
                    const color = `rgba(102, 126, 234, ${opacity})`;
                    html += `<div style="padding: 8px; background: ${color}; text-align: center; cursor: pointer; min-width: 20px;" title="${day.weekday_name} ${hour.hour}:00 - ${hour.count} —Å–æ–æ–±—â–µ–Ω–∏–π">${hour.count > 0 ? hour.count : ''}</div>`;
                });
            });
            
            html += '</div>';
            html += '<div style="margin-top: 15px; font-size: 12px; color: #666;">';
            html += '<strong>–°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã:</strong><br>';
            if (heatmap.most_active_periods && heatmap.most_active_periods.length > 0) {
                heatmap.most_active_periods.slice(0, 5).forEach(period => {
                    html += `${period.weekday} ${period.hour}:00 (${period.count} —Å–æ–æ–±—â–µ–Ω–∏–π)<br>`;
                });
            }
            html += '</div>';
            html += '</div>';
            
            document.getElementById('heatmapContainer').innerHTML = html;
        }
        
        function renderSemanticAnalysis(semantic) {
            if (!semantic) {
                document.getElementById('semanticStats').innerHTML = '<p style="color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</p>';
                return;
            }
            
            let html = '';
            
            // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π
            if (semantic.message_length_distribution) {
                html += '<h3 style="color: #667eea; margin: 20px 0 10px 0;">üìè –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π:</h3>';
                html += '<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">';
                const dist = semantic.message_length_distribution;
                html += `
                    <div class="stat-card">
                        <div class="stat-value">${dist.short}</div>
                        <div class="stat-label">–ö–æ—Ä–æ—Ç–∫–∏–µ (&lt;10 —Å–∏–º–≤–æ–ª–æ–≤)</div>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">${dist.short_percentage}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${dist.medium}</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω–∏–µ (10-50 —Å–∏–º–≤–æ–ª–æ–≤)</div>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">${dist.medium_percentage}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${dist.long}</div>
                        <div class="stat-label">–î–ª–∏–Ω–Ω—ã–µ (&gt;50 —Å–∏–º–≤–æ–ª–æ–≤)</div>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">${dist.long_percentage}%</div>
                    </div>
                `;
                html += '</div>';
            }
            
            // –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è
            if (semantic.communication_style) {
                html += '<h3 style="color: #667eea; margin: 20px 0 10px 0;">üí¨ –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:</h3>';
                html += '<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">';
                const style = semantic.communication_style;
                html += `
                    <div class="stat-card">
                        <div class="stat-value">${style.question_messages}</div>
                        <div class="stat-label">–°–æ–æ–±—â–µ–Ω–∏–π —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏</div>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">${style.question_percentage}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${style.exclamation_messages}</div>
                        <div class="stat-label">–°–æ–æ–±—â–µ–Ω–∏–π —Å –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏—è–º–∏</div>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">${style.exclamation_percentage}%</div>
                    </div>
                `;
                html += '</div>';
            }
            
            // –¢–µ–º—ã
            if (semantic.topics && Object.keys(semantic.topics).length > 0) {
                html += '<h3 style="color: #667eea; margin: 20px 0 10px 0;">üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã:</h3>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                for (const [topic, count] of Object.entries(semantic.topics)) {
                    html += `
                        <div style="background: #f0f0f0; padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-weight: bold; color: #667eea;">${escapeHtml(topic)}</span>
                            <span style="color: #666;">${count} —É–ø–æ–º–∏–Ω–∞–Ω–∏–π</span>
                        </div>
                    `;
                }
                html += '</div>';
            }
            
            // –í—Ä–µ–º—è —Å—É—Ç–æ–∫
            if (semantic.time_periods) {
                html += '<h3 style="color: #667eea; margin: 20px 0 10px 0;">‚è∞ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫:</h3>';
                html += '<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">';
                const periods = semantic.time_periods;
                const percentages = semantic.time_periods_percentage || {};
                for (const [period, count] of Object.entries(periods)) {
                    html += `
                        <div class="stat-card">
                            <div class="stat-value">${count}</div>
                            <div class="stat-label">${period.charAt(0).toUpperCase() + period.slice(1)}</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">${percentages[period] || 0}%</div>
                        </div>
                    `;
                }
                html += '</div>';
            }
            
            document.getElementById('semanticStats').innerHTML = html;
        }
        
        function renderMessageSeries(series) {
            if (!series || !series.author_series || Object.keys(series.author_series).length === 0) {
                document.getElementById('messageSeriesStats').innerHTML = '<p style="color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ—Ä–∏—è—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
                return;
            }
            let html = '<h3 style="color: #667eea; margin-bottom: 15px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º:</h3>';
            html += '<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">';
            for (const [author, stats] of Object.entries(series.author_series)) {
                html += `<div class="stat-card"><h4 style="color: #667eea; margin-bottom: 10px;">${escapeHtml(author)}</h4><div class="stat">–í—Å–µ–≥–æ —Å–µ—Ä–∏–π: <strong>${stats.total_series}</strong></div><div class="stat">–°–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ—Ä–∏—è—Ö: <strong>${stats.total_messages_in_series}</strong></div><div class="stat">–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ —Å–µ—Ä–∏–∏: <strong>${stats.avg_series_length}</strong></div><div class="stat">–ú–∞–∫—Å. –¥–ª–∏–Ω–∞: <strong>${stats.max_series_length}</strong></div><div style="margin-top: 10px; font-size: 12px; color: #666;"><div>3-5 —Å–æ–æ–±—â–µ–Ω–∏–π: ${stats.series_distribution['3-5']}</div><div>6-10 —Å–æ–æ–±—â–µ–Ω–∏–π: ${stats.series_distribution['6-10']}</div><div>11-20 —Å–æ–æ–±—â–µ–Ω–∏–π: ${stats.series_distribution['11-20']}</div><div>20+ —Å–æ–æ–±—â–µ–Ω–∏–π: ${stats.series_distribution['20+']}</div></div></div>`;
            }
            html += '</div>';
            document.getElementById('messageSeriesStats').innerHTML = html;
        }
        
        function renderReactionSpeed(reaction) {
            if (!reaction) {
                document.getElementById('reactionSpeedStats').innerHTML = '<p style="color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ä–µ–∞–∫—Ü–∏–∏</p>';
                return;
            }
            let html = '';
            if (reaction.avg_response_times && Object.keys(reaction.avg_response_times).length > 0) {
                html += '<h3 style="color: #667eea; margin-bottom: 15px;">‚è±Ô∏è –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</h3>';
                html += '<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">';
                for (const [author, stats] of Object.entries(reaction.avg_response_times)) {
                    html += `<div class="stat-card"><h4 style="color: #667eea;">${escapeHtml(author)}</h4><div class="stat-value">${stats.avg_minutes}</div><div class="stat-label">–º–∏–Ω—É—Ç (—Å—Ä–µ–¥–Ω–µ–µ)</div><div style="font-size: 12px; color: #999; margin-top: 5px;">–ú–µ–¥–∏–∞–Ω–∞: ${stats.median_minutes} –º–∏–Ω<br>–í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤: ${stats.total_responses}</div></div>`;
                }
                html += '</div>';
            }
            if (reaction.response_distribution && Object.keys(reaction.response_distribution).length > 0) {
                html += '<h3 style="color: #667eea; margin: 30px 0 15px 0;">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏:</h3>';
                html += '<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">';
                for (const [author, dist] of Object.entries(reaction.response_distribution)) {
                    const total = dist.under_5min + dist.under_1hour + dist.under_1day + dist.over_1day;
                    html += `<div class="stat-card"><h4 style="color: #667eea;">${escapeHtml(author)}</h4><div style="font-size: 14px;"><div>–î–æ 5 –º–∏–Ω: ${dist.under_5min} (${total > 0 ? (dist.under_5min/total*100).toFixed(1) : 0}%)</div><div>–î–æ 1 —á–∞—Å–∞: ${dist.under_1hour} (${total > 0 ? (dist.under_1hour/total*100).toFixed(1) : 0}%)</div><div>–î–æ 1 –¥–Ω—è: ${dist.under_1day} (${total > 0 ? (dist.under_1day/total*100).toFixed(1) : 0}%)</div><div>–ë–æ–ª–µ–µ –¥–Ω—è: ${dist.over_1day} (${total > 0 ? (dist.over_1day/total*100).toFixed(1) : 0}%)</div></div></div>`;
                }
                html += '</div>';
            }
            if (reaction.conversation_starters && Object.keys(reaction.conversation_starters).length > 0) {
                html += '<h3 style="color: #667eea; margin: 30px 0 15px 0;">üöÄ –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä—ã –¥–∏–∞–ª–æ–≥–æ–≤ (–ø–æ—Å–ª–µ –ø–∞—É–∑—ã >6—á):</h3>';
                html += '<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">';
                const sorted = Object.entries(reaction.conversation_starters).sort((a, b) => b[1] - a[1]);
                for (const [author, count] of sorted) {
                    html += `<div class="stat-card"><div class="stat-value">${count}</div><div class="stat-label">${escapeHtml(author)}</div></div>`;
                }
                html += '</div>';
            }
            document.getElementById('reactionSpeedStats').innerHTML = html;
        }
        
        function renderParticipantBalance(balance) {
            if (!balance || !balance.participants) {
                document.getElementById('participantBalanceStats').innerHTML = '<p style="color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±–∞–ª–∞–Ω—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>';
                return;
            }
            let html = '<h3 style="color: #667eea; margin-bottom: 15px;">‚öñÔ∏è –í–∫–ª–∞–¥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</h3>';
            html += '<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">';
            for (const [author, stats] of Object.entries(balance.participants)) {
                html += `<div class="stat-card"><h4 style="color: #667eea; margin-bottom: 10px;">${escapeHtml(author)}</h4><div class="stat">–î–æ–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π: <strong>${stats.message_percentage}%</strong></div><div class="stat">–î–æ–ª—è —Å–ª–æ–≤: <strong>${stats.word_percentage}%</strong></div><div class="stat">–î–æ–ª—è —Å–∏–º–≤–æ–ª–æ–≤: <strong>${stats.character_percentage}%</strong></div><div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;"><div class="stat">–í–æ–ø—Ä–æ—Å–æ–≤: <strong>${stats.questions_count}</strong></div><div class="stat">–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π: <strong>${stats.statements_count}</strong></div><div class="stat">–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤: <strong>${stats.question_ratio}%</strong></div></div></div>`;
            }
            html += '</div>';
            document.getElementById('participantBalanceStats').innerHTML = html;
        }
        
        function renderEmotionalAnalysis(emotional) {
            if (!emotional) {
                document.getElementById('emotionalStats').innerHTML = '<p style="color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</p>';
                return;
            }
            let html = '';
            if (emotional.tense_days && emotional.tense_days.length > 0) {
                html += '<h3 style="color: #667eea; margin-bottom: 15px;">üò∞ –î–Ω–∏ —Å –≤—ã—Å–æ–∫–æ–π –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ—Å—Ç—å—é (>30%):</h3>';
                html += '<div style="display: flex; flex-direction: column; gap: 10px;">';
                emotional.tense_days.slice(0, 10).forEach(day => {
                    html += `<div class="interesting-item"><div class="header"><span class="author">${new Date(day.date).toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span><span class="date">${day.negative_ratio}% –Ω–µ–≥–∞—Ç–∏–≤–∞ ‚Ä¢ ${day.total_messages} —Å–æ–æ–±—â–µ–Ω–∏–π</span></div></div>`;
                });
                html += '</div>';
            }
            if (emotional.topic_emotions && Object.keys(emotional.topic_emotions).length > 0) {
                html += '<h3 style="color: #667eea; margin: 30px 0 15px 0;">üéØ –≠–º–æ—Ü–∏–∏ –ø–æ —Ç–µ–º–∞–º:</h3>';
                html += '<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">';
                for (const [topic, emotions] of Object.entries(emotional.topic_emotions)) {
                    html += `<div class="stat-card"><h4 style="color: #667eea;">${escapeHtml(topic)}</h4><div style="font-size: 14px;">${emotions.positive > 0 ? `<div style="color: green;">üòä –ü–æ–∑–∏—Ç–∏–≤: ${emotions.positive}</div>` : ''}${emotions.negative > 0 ? `<div style="color: red;">üò† –ù–µ–≥–∞—Ç–∏–≤: ${emotions.negative}</div>` : ''}${emotions.anxiety > 0 ? `<div style="color: orange;">üò∞ –¢—Ä–µ–≤–æ–≥–∞: ${emotions.anxiety}</div>` : ''}</div></div>`;
                }
                html += '</div>';
            }
            document.getElementById('emotionalStats').innerHTML = html || '<p style="color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</p>';
        }
        
        function renderCommunicationStyle(style) {
            if (!style || !style.author_styles) {
                document.getElementById('communicationStyleStats').innerHTML = '<p style="color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç–∏–ª–µ –æ–±—â–µ–Ω–∏—è</p>';
                return;
            }
            let html = '<h3 style="color: #667eea; margin-bottom: 15px;">üí¨ –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º:</h3>';
            html += '<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">';
            for (const [author, stats] of Object.entries(style.author_styles)) {
                html += `<div class="stat-card"><h4 style="color: #667eea; margin-bottom: 10px;">${escapeHtml(author)}</h4><div class="stat">–§–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç—å: <strong>${stats.formality_ratio}%</strong></div><div class="stat">–≠–º–æ–¥–∑–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ: <strong>${stats.emojis_per_message}</strong></div><div class="stat">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ö–ê–ü–°: <strong>${stats.caps_usage}</strong></div><div class="stat">–ú–Ω–æ–≥–æ—Ç–æ—á–∏—è: <strong>${stats.ellipsis_usage}</strong></div><div class="stat">–í–æ—Å–∫–ª–∏—Ü–∞–Ω–∏—è: <strong>${stats.exclamation_usage}</strong></div><div class="stat">–õ–µ–∫—Å–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ: <strong>${stats.lexical_diversity}%</strong></div>${Object.keys(stats.top_parasite_words).length > 0 ? `<div style="margin-top: 10px; font-size: 12px; color: #666;"><strong>–ü–∞—Ä–∞–∑–∏—Ç–Ω—ã–µ —Å–ª–æ–≤–∞:</strong><br>${Object.entries(stats.top_parasite_words).map(([word, count]) => `${word} (${count})`).join(', ')}</div>` : ''}</div>`;
            }
            html += '</div>';
            document.getElementById('communicationStyleStats').innerHTML = html;
        }
        
        function renderConflictAnalysis(conflict) {
            if (!conflict) {
                document.getElementById('conflictStats').innerHTML = '<p style="color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤</p>';
                return;
            }
            let html = '';
            if (conflict.marker_phrases) {
                html += '<h3 style="color: #667eea; margin-bottom: 15px;">üîñ –ú–∞—Ä–∫–µ—Ä–Ω—ã–µ —Ñ—Ä–∞–∑—ã:</h3>';
                for (const [category, phrases] of Object.entries(conflict.marker_phrases)) {
                    if (Object.keys(phrases).length > 0) {
                        const categoryNames = {'resolution': '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ', 'tension': '–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ', 'apology': '–ò–∑–≤–∏–Ω–µ–Ω–∏—è', 'compromise': '–ö–æ–º–ø—Ä–æ–º–∏—Å—Å'};
                        html += `<h4 style="color: #764ba2; margin: 20px 0 10px 0;">${categoryNames[category] || category}:</h4>`;
                        html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                        for (const [phrase, count] of Object.entries(phrases)) {
                            html += `<div style="background: #f0f0f0; padding: 8px 12px; border-radius: 6px;"><span style="font-weight: bold;">${escapeHtml(phrase)}</span><span style="color: #666; margin-left: 5px;">(${count})</span></div>`;
                        }
                        html += '</div>';
                    }
                }
            }
            if (conflict.apology_stats || conflict.compromise_stats) {
                html += '<h3 style="color: #667eea; margin: 30px 0 15px 0;">ü§ù –ò–∑–≤–∏–Ω–µ–Ω–∏—è –∏ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å—ã:</h3>';
                html += '<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">';
                if (conflict.apology_stats) {
                    for (const [author, count] of Object.entries(conflict.apology_stats)) {
                        html += `<div class="stat-card"><div class="stat-value">${count}</div><div class="stat-label">${escapeHtml(author)} - –ò–∑–≤–∏–Ω–µ–Ω–∏—è</div></div>`;
                    }
                }
                if (conflict.compromise_stats) {
                    for (const [author, count] of Object.entries(conflict.compromise_stats)) {
                        html += `<div class="stat-card"><div class="stat-value">${count}</div><div class="stat-label">${escapeHtml(author)} - –ö–æ–º–ø—Ä–æ–º–∏—Å—Å—ã</div></div>`;
                    }
                }
                html += '</div>';
            }
            document.getElementById('conflictStats').innerHTML = html || '<p style="color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤</p>';
        }
        
        function renderSeasonality(seasonality) {
            if (!seasonality) {
                document.getElementById('seasonalityStats').innerHTML = '<p style="color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏</p>';
                return;
            }
            let html = '';
            if (seasonality.peaks) {
                html += '<h3 style="color: #667eea; margin-bottom: 15px;">üìà –ü–∏–∫–∏ –∏ –ø—Ä–æ—Å–∞–¥–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</h3>';
                html += '<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">';
                const peaks = seasonality.peaks;
                if (peaks.max_week && peaks.max_week.period) {
                    html += `<div class="stat-card"><div class="stat-value" style="color: green;">${peaks.max_week.messages}</div><div class="stat-label">–ú–∞–∫—Å. –Ω–µ–¥–µ–ª—è: ${peaks.max_week.period}</div></div>`;
                }
                if (peaks.min_week && peaks.min_week.period) {
                    html += `<div class="stat-card"><div class="stat-value" style="color: red;">${peaks.min_week.messages}</div><div class="stat-label">–ú–∏–Ω. –Ω–µ–¥–µ–ª—è: ${peaks.min_week.period}</div></div>`;
                }
                if (peaks.max_month && peaks.max_month.period) {
                    html += `<div class="stat-card"><div class="stat-value" style="color: green;">${peaks.max_month.messages}</div><div class="stat-label">–ú–∞–∫—Å. –º–µ—Å—è—Ü: ${peaks.max_month.period}</div></div>`;
                }
                if (peaks.min_month && peaks.min_month.period) {
                    html += `<div class="stat-card"><div class="stat-value" style="color: red;">${peaks.min_month.messages}</div><div class="stat-label">–ú–∏–Ω. –º–µ—Å—è—Ü: ${peaks.min_month.period}</div></div>`;
                }
                html += '</div>';
            }
            if (seasonality.weekly_activity && Object.keys(seasonality.weekly_activity).length > 0) {
                html += '<h3 style="color: #667eea; margin: 30px 0 15px 0;">üìÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –Ω–µ–¥–µ–ª—è–º:</h3>';
                html += '<div style="max-height: 300px; overflow-y: auto;"><table style="width: 100%; border-collapse: collapse;"><tr style="background: #f0f0f0;"><th style="padding: 10px; text-align: left;">–ù–µ–¥–µ–ª—è</th><th style="padding: 10px; text-align: right;">–°–æ–æ–±—â–µ–Ω–∏–π</th></tr>';
                for (const [week, count] of Object.entries(seasonality.weekly_activity)) {
                    html += `<tr><td style="padding: 8px;">${week}</td><td style="padding: 8px; text-align: right;">${count}</td></tr>`;
                }
                html += '</table></div>';
            }
            document.getElementById('seasonalityStats').innerHTML = html || '<p style="color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏</p>';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function updateCurrentFileInfo() {
            try {
                const response = await fetch('/api/current_file');
                const data = await response.json();
                document.getElementById('currentFileName').textContent = data.filename;
                return data;
            } catch (error) {
                document.getElementById('currentFileName').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                return { is_loaded: false };
            }
        }
        
        function showFileUpload() {
            const section = document.getElementById('fileUploadSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const statusDiv = document.getElementById('uploadStatus');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                statusDiv.innerHTML = '<div style="color: red; padding: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            statusDiv.innerHTML = '<div style="color: #667eea; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 16px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...</div>';
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    statusDiv.innerHTML = `<div style="color: red; padding: 15px; background: #fee; border-radius: 8px; font-size: 16px;">‚ùå –û—à–∏–±–∫–∞: ${data.error}</div>`;
                    return;
                }
                
                statusDiv.innerHTML = `<div style="color: green; padding: 15px; background: #e8f5e9; border-radius: 8px; font-size: 16px;">‚úÖ ${data.message}: ${data.filename}</div>`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
                await updateCurrentFileInfo();
                
                // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∞–Ω–∞–ª–∏–∑–∞
                document.getElementById('fileUploadSection').style.display = 'none';
                document.getElementById('loading').style.display = 'block';
                document.getElementById('content').style.display = 'none';
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                await loadData();
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="color: red; padding: 10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }
        
        
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.toggle('mobile-visible');
            sidebar.classList.toggle('mobile-hidden');
            overlay.classList.toggle('active');
        }
        
        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.remove('mobile-visible');
            sidebar.classList.add('mobile-hidden');
            overlay.classList.remove('active');
        }
        
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é
                document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
                if (window.innerWidth <= 768) {
                    closeMobileMenu();
                }
                event.target.closest('a').classList.add('active');
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∞–π–ª–∞
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                const fileInputButton = document.querySelector('.file-input-button');
                if (this.files && this.files.length > 0 && fileInputButton) {
                    const fileName = this.files[0].name;
                    fileInputButton.textContent = `üìÅ –í—ã–±—Ä–∞–Ω: ${fileName.length > 30 ? fileName.substring(0, 30) + '...' : fileName}`;
                    fileInputButton.style.background = '#e3f2fd';
                    fileInputButton.style.borderColor = '#4a90e2';
                }
            });
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        const mobileOverlay = document.getElementById('mobileOverlay');
        if (mobileOverlay) {
            mobileOverlay.addEventListener('click', closeMobileMenu);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadData();
    </script>
</body>
</html>

